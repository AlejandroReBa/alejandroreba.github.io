<!DOCTYPE html>
<html>
<head>
<title>
HERO VS BOSS
</title>
<style>
#countdown{
    font-family: sans-serif;
    color: #ff0000;
    font-weight: 100;
    font-size: 30px;
}
</style>
<script type='text/javascript'>

var canvas;

var backgroundImage;
var menuImage;

var hero;
var boss;
var actualLevel;

function Hero (x, y, i, s)
{
	this.x = x;
	this.y = y;
	this.heroImage = i;
	this.speed = s;
	this.width = this.heroImage.style.width.replace("px","");
	this.height = this.heroImage.style.height.replace("px","");
}

Hero.prototype.moveUp = function(canvas){
	clearCanvas(canvas);
	ctx = canvas.getContext('2d');
	if(this.y <= this.speed - 1){
		this.y = canvas.height - this.height - (this.speed -1)
	}else{
		this.y -= this.speed;
	}
	
	redrawCharacters();
}

Hero.prototype.moveDown = function(canvas){
	clearCanvas(canvas);
	ctx = canvas.getContext('2d');
	if(this.y >= canvas.height - this.height - (this.speed -1)){
		this.y = 0
	}else{
		this.y += this.speed;
	}
	redrawCharacters();
}


Hero.prototype.moveRight = function(canvas){
	clearCanvas(canvas);
	ctx = canvas.getContext('2d')
	if(this.x >= canvas.width - this.width - (this.speed-1)){
		this.x = 0
	}else{
		this.x += this.speed;
	}
	redrawCharacters();
}


Hero.prototype.moveLeft = function(canvas){
	clearCanvas(canvas);
	ctx = canvas.getContext('2d');
	if(this.x <= (this.speed - 1)){
		this.x = canvas.width - this.width - (this.speed-1)
	}else{
		this.x -= this.speed;
	}
	redrawCharacters();
}

Hero.prototype.changeSpeed = function(speedIn){
	this.speed = speedIn;
}


function Boss (x, y, i, s)
{
	this.x = x;
	this.y = y;
	this.bossImage = i;
	this.speed = s;
	this.width = this.bossImage.style.width.replace("px","");
	this.height = this.bossImage.style.height.replace("px","");
	this.minDistanceY = canvas.height;
	this.minDistanceX = canvas.width;
}

Boss.prototype.moveUp = function(canvas){
	clearCanvas(canvas);
	ctx = canvas.getContext('2d');
	if(this.y <= this.speed - 1){
		this.y = canvas.height - this.height - (this.speed -1)
	}else if (this.speed < this.minDistanceY){
		this.y -= this.speed;
	}else{
		this.y -= this.minDistanceY;
	}
	redrawCharacters();
}

Boss.prototype.moveDown = function(canvas){
	clearCanvas(canvas);
	ctx = canvas.getContext('2d');
	if(this.y >= canvas.height - this.height - (this.speed -1)){
		this.y = 0
	}else if (this.speed < this.minDistanceY){
		this.y += this.speed;
	}else{
		this.y += this.minDistanceY;
	}
	redrawCharacters();
}


Boss.prototype.moveRight = function(canvas){
	clearCanvas(canvas);
	ctx = canvas.getContext('2d')
	if(this.x >= canvas.width - this.width - (this.speed-1)){
		this.x = 0
	}else if (this.speed < this.minDistanceX){
		this.x += this.speed;
	}else{
		this.x += this.minDistanceX;
	}
	redrawCharacters();
}


Boss.prototype.moveLeft = function(canvas){
	clearCanvas(canvas);
	ctx = canvas.getContext('2d');
	if(this.x <= (this.speed - 1)){
		this.x = canvas.width - this.width - (this.speed-1)
	}else if (this.speed < this.minDistanceX){
		this.x -= this.speed;
	}else{
		this.x -= this.minDistanceX;
	}
	redrawCharacters();
}

Boss.prototype.changeSpeed = function(){
	boss.speed += 10;
	
}

Boss.prototype.bossIA = function()
{
    var ctx = canvas.getContext("2d");
	var movement = boss.moveDirection();
	if (movement == 1){
		boss.moveLeft(canvas);
	}else if (movement == 2){
		boss.moveRight(canvas);
	}else if (movement == 3){
		boss.moveUp(canvas);
	}else if (movement == 4){
		boss.moveDown(canvas);
	}
  
}

Boss.prototype.moveDirection = function()
{
	var shortestDistanceX;
	var shortestDistanceY;
	var movementX;
	var movementY;
	
	var distance = boss.x - hero.x;
	if (distance > 0){
		shortestDistanceX = distance;
		movementX = 1; //left
	}else{
		shortestDistanceX = -distance;
		movementX = 2; //right
	}
	
	distance = boss.y - hero.y;
	if (distance > 0){
		shortestDistanceY = distance;
		movementY = 3; //up
	}else{
		shortestDistanceY = -distance;
		movementY = 4; //down
	}
	
	this.minDistanceX = shortestDistanceX;
	this.minDistanceY = shortestDistanceY;
	if (shortestDistanceX > 0 && (shortestDistanceX < shortestDistanceY || shortestDistanceY==0)){
		return movementX;
	}else if (shortestDistanceY > 0){
		return movementY;
	}else{
		return 5; //no movement;
	}
	//alert("movement-- " + movement);
}

function Level(reactionTimeIn, incrementSpeedIn, timeToWinLevelIn){
	this.reactionTime = reactionTimeIn;
	this.incrementSpeed = incrementSpeedIn;
	this.timeToWinLevel = timeToWinLevelIn;
	document.getElementById("countdown").innerHTML = timeToWinLevelIn;
}

Level.prototype.countdown = function(){
	var timeRemaining = document.getElementById("countdown").innerHTML;
	timeRemaining -= 1;
	document.getElementById("countdown").innerHTML = timeRemaining;
	if (timeRemaining == 0){
		actualLevel.playerWins();
	}
}

Level.prototype.playerWins = function(){
	canvas.removeEventListener("keyup", handleKeyEvent);
	clearAllIntervals();
	ctx.font='48pt Helvetica';
	ctx.fillStyle='green';
	var text = "BOSS DEFEATED"
	ctx.fillText(text,800,500);
	document.getElementById("soundId").src = "sounds/Pursuit.mp3";
}	

Level.prototype.gameOver = function(){
	canvas.removeEventListener("keyup", handleKeyEvent);
	clearAllIntervals();
	ctx.font='48pt Helvetica';
	ctx.fillStyle='#8B0000';
	var text = "GAME OVER"
	ctx.fillText(text,800,500);
	document.getElementById("soundId").src = "sounds/Pride.mp3";
}


function init()
{
    canvas = document.getElementById('canvas1');
    //document.getElementById("startbtn").addEventListener ("click", start);
    //document.getElementById("endbtn").addEventListener ("click", end);
	canvas.addEventListener ("keyup", handleKeyEvent);
	var reactionTime = 100 //each 100 ms boss does something new.
	var incrementSpeed = 5000 //each 5 seg the boss increments its speed
	var timeToWinLevel = 60 //to pass lvl 1 you have to survive for 60 seg
	actualLevel = new Level (reactionTime, incrementSpeed, timeToWinLevel);
	
	loadMenu();
	
}

function loadMenu(){
	var ctx = canvas.getContext('2d');
	
	menuImage = new Image();
	menuImage.src = 'img/menu.png';
	
	menuImage.onload = function(){
	ctx.drawImage(menuImage, canvas.width/4, canvas.height/4, 2*canvas.width/3, 2*canvas.height/3);
	canvas.addEventListener ('mousedown', skipMenu);
	}
}

function skipMenu (){
	canvas.removeEventListener('mousedown', skipMenu);
	loadImage();
}

function loadImage(){
	var ctx = canvas.getContext('2d');
	
	backgroundImage = new Image();
	backgroundImage.src = 'img/backgroundLvl1.png';
	
	backgroundImage.onload = function(){
	ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
	}	
	
	var hero_image = new Image();
	hero_image.src = 'img/berserkerhero.png';
	
	hero_image.onload = function(){
	hero_image.style.width = '125px';
	hero_image.style.height= '135px';

	ctx.drawImage(hero_image, 50, 200, 125, 135);
	hero = new Hero(50, 200, hero_image, 10);
	}
	
	var boss_image = new Image();
	boss_image.src = 'img/bossZelda.png';
	
	boss_image.onload = function(){
	boss_image.style.width = '225px';
	boss_image.style.height= '235px';

	ctx.drawImage(boss_image, 500, 500, 225, 235);
	boss = new Boss(500, 500, boss_image, 5);
	
	setAllIntervals();
	document.getElementById("soundId").src = "sounds/Sacrifice.mp3";
	}
	
}

function handleKeyEvent(e)
{
	if (e.keyCode == 37){
		hero.moveLeft(canvas);
	}else if (e.keyCode == 38){
		hero.moveUp(canvas);
	}else if (e.keyCode == 39){
		hero.moveRight(canvas);
	}else if (e.keyCode == 40){
		hero.moveDown(canvas);
	}else if (e.keyCode == 83){ //83 = s from speed
		var newSpeed = Math.floor(Math.random()*(100-5) + 5);
		alert ("New speed: " + newSpeed);
		hero.changeSpeed(newSpeed);
	}else if (e.keyCode == 80){ //p = pause
		var pause = "       PAUSE \n\nYour speed: " + hero.speed + " \nBoss speed: " + boss.speed;
		alert (pause);
	}
}

function clearCanvas(canvas){
	var ctx = canvas.getContext('2d')
	ctx.clearRect(0, 0, canvas.width, canvas.height);
	ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
}


function redrawCharacters(){
	var ctx = canvas.getContext('2d')
	ctx.drawImage(hero.heroImage, hero.x, hero.y, hero.width, hero.height);
	ctx.drawImage(boss.bossImage, boss.x, boss.y, boss.width, boss.height);
	
	if (hero.x == boss.x && hero.y == boss.y){
		actualLevel.gameOver();
		/*
		canvas.removeEventListener("keyup", handleKeyEvent);
		clearInterval(boss.bossIAHandle);
		clearInterval(boss.bossIncSpeedHandle);
		ctx.font='48pt Helvetica';
		ctx.fillStyle='#8B0000';
		var text = "GAME OVER"
		ctx.fillText(text,825,500);
		*/
	}
}
function status(id,txt)
{
    document.getElementById(id).innerHTML = txt;
}

function start()
{
    if(handle)
    {
        alert("Function already scheduled!");
    }
    else
    {
        //handle=setInterval(doUpdate, 2000);
        //index = 0;
		loadImage();
    }
}

function end()
{
    // Clear the function and set "handle" to null so that the test
    // in "start" will work and we'll be able to schedule the function
    // again.
    if(handle) 
    {
        clearInterval(handle);
        handle=null; 
    }
}

function setAllIntervals(){
	boss.bossIAHandle = setInterval(boss.bossIA, actualLevel.reactionTime);
	boss.bossIncSpeedHandle = setInterval(boss.changeSpeed, actualLevel.incrementSpeed);
	actualLevel.timeHandle = setInterval(actualLevel.countdown, 1000);
}

function clearAllIntervals(){
	clearInterval(boss.bossIAHandle);
	clearInterval(boss.bossIncSpeedHandle);
	clearInterval(actualLevel.timeHandle);
}

</script>
</head>
<body onload='init()'>
<p>
<canvas id='canvas1' width='1800' height='1050' tabindex='0'>
</canvas> <br/>
COUNTDOWN TO DEFEAT THE BOSS:
<span id="countdown">
</span>
seconds
</p>
 <audio id="soundId" autoplay>
 <source src="sounds/Mass.mp3" type="audio/mpeg">
 <!--<source src="sounds/sacrifice.mp3" type="audio/mpeg">-->
  <!--<source src="sounds/Hej.mp3" type="audio/mpeg"> -->
  <!--<source src="sounds/Pursuit.mp3" type="audio/mpeg"> -->
Your browser does not support the audio element.
</audio> 
</html>
